{-# LANGUAGE InstanceSigs #-}
module Part3 where
import Test.Hspec
import Test.Hspec.QuickCheck
import Test.QuickCheck

-- | eDSL for defined arithmetic expressions
data Expr =
  Lit Int
  | Add Expr Expr
  | Sub Expr Expr
  | Mul Expr Expr
  deriving (Show, Eq)

eval :: Expr -> Int
eval (Lit i) = i
eval (Add e1 e2) = eval e1 + eval e2
eval (Sub e1 e2) = eval e1 - eval e2
eval (Mul e1 e2) = eval e1 * eval e2

-- | One-pass simplification
simplify :: Expr -> Expr
simplify (Add (Lit 1) e) = e
simplify (Add e (Lit 0)) = e
simplify (Mul _ (Lit 0)) = Lit 0
simplify (Mul (Lit 0) _) = Lit 0
simplify (Add e1 e2) = Add (simplify e1) (simplify e2)
simplify (Sub e1 e2) = Sub (simplify e1) (simplify e2)
simplify (Mul e1 e2) = Mul (simplify e1) (simplify e2)
simplify (Lit i) = Lit i

{-
Property:
  1. Preserve semantics
  2. Simplification makes the expr smaller or equal
 -}

prop_simplify_preserve_semantics :: SpecWith()
prop_simplify_preserve_semantics =
  modifyMaxSuccess (const 1000) $ do
    prop "'simplify' preserves semantics" $
      \e -> eval e == eval (simplify e)
    prop "'simplify' makes expr smaller (or equal size)" $
      \e -> size (simplify e) <= size e
-- Wait, how does this work? MAGIC?

size :: Expr -> Int
size (Lit _) = 1
size (Add e1 e2) = 1 + size e1 + size e2
size (Sub e1 e2) = 1 + size e1 + size e2
size (Mul e1 e2) = 1 + size e1 + size e2


instance Arbitrary Expr where

  arbitrary :: Gen Expr
  arbitrary = sized $ \n ->
    if n <= 1 then
      Lit <$> arbitrary
    else
      oneof [
        Lit <$> arbitrary
        , Add <$> resize (div n 2) arbitrary <*> resize (div n 2) arbitrary
        , Sub <$> resize (div n 2) arbitrary <*> resize (div n 2) arbitrary
        , Mul <$> resize (div n 2) arbitrary <*> resize (div n 2) arbitrary
      ]

  -- Less headache for counter examples!
  shrink :: Expr -> [Expr]
  shrink (Lit _) = []
  shrink (Add e1 e2) = shrink e1 ++ shrink e2 ++ [e1, e2]
  shrink (Sub e1 e2) = shrink e1 ++ shrink e2 ++ [e1, e2]
  shrink (Mul e1 e2) = shrink e1 ++ shrink e2 ++ [e1, e2]




























































{-
%%%%%%%%%%%%%%%%%%##%%%%%@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%@@###########%#%%%%%%%%%%%%%%%%%%%%%%%%%%%%#*####%%%%##%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%@%%%%%%%%%#####%%%#%%%%%%%%%%%%%#**++++#**############%##########%%####%#%%%%%%%#%%%%%######
%%%%%%%%%%%%%%%%%%######%%%%%%%%#%###***++=**+**+*+*####**######***#################################
%%%%%%%%%%%%%%%%%#########%#######****+***+#+=#*++*++#+*######****+++###############################
%%%%%%%%%%%%%%%%%#**#########**#*##########%%##+***###%##%#*##**++**#+*#############################
%%%%%%%%%%%%%%%%%#**#############%##*******##*#+*=##%####**#*++*#+++*+**############################
########************#########%*#***+==+++=+*###****#*+*++=**+----+*+++***###########################
********************########*=-==-=-=----------==++=+===-=--:::::==**++****#########################
********************#####**---=====-------::::::..:....:::::::--:--=+#++***#########################
*****#**************####*#-.=-+====-------:::::.......:::::::::--=:==+++*##*########################
********************%###*==---=========----:::.:-:::::::-:-:--------=+*#+*##########################
********************###*+=:--++=+++===-----::--:---::::::::---==:-=-===++++**#######################
********************%#**+====+*+++=+========-----:::--::--------===++==-==+**#######################
********************%#**++++++=++=++=====++=--------------=------=======+=+*+#######################
********************##****+++++++========-----:-::-==-==-::::-----=====++++**#######################
********************####*++*#**+++++===-=----=++=--==-----==--::-----==+**+*+*######################
*******************#####*+*##**++++++++===***#***++=--===++**+=-------=*#*****######################
********************###%#**%##*+++*********########+--=********++======*##***#######################
********************%#%%%##%@@@@@@@@%#**#%@%##%%%%%+--+####%%%#***++++=*##***#######################
********************####%###++#*+@@*###%@%@@%%#%%%@@*-*#%@##%%%%@@%#***%##**########################
*******************###%@%%#**###*+#++*#***++****+=*+.:=@+**********=+#%@***#########################
*******************####%%%@%#####++=-=+**++*+=:-:%%=::-@---=++++==--++%+#*##########################
*******************####%%@@@%####*=#==----::::--=#=-::-*=-:::::::---*****###########################
*******************##%##%%%@%####*++==-=##=:::--%+=-::--*++--------=*#**############################
*******************#####%%#%#####****+++++***#%=-=++=---=-##*####*+=++**############################
#******************%####%##%####****###*****#%%%%%##****##*###***+++==*#############################
**#****************%####%#**#####****##**+*#%*#*########****##*+++*+++*###########################%#
**#****************#####%%%%%#####***********+-+++***#*#+--+****++**+*#%##########################%#
**#****************#####%%%%%######********=#**##########***++#*++++**############################%#
******************#%####%%%%%#######*****+*#%@@@@@@@@@@@%%%%%**++++**###############################
******************#%%###%%#%%##########*++*%#*+++++****+-==+*#+=+++**###############################
*************####*#%%###%%%%%########**++-*+==+*+++****+===-==+++++*################################
******************##%###%%%%%%######*****==--=--==+====:-:--:::=++*###%#############################
********##********##%###%%%@%%#######**#*++=--=:--=+===+---:.:++++###%##############################
******************##%###%#+**%######*****#*+++==-*+++=*=+-:--=+++*####%%#########################%##
##********#******###%##+===#+@###*####**##+*++++=+++*+++==+++++*+%%###%%%%#######################%##
###########******#%#--=*=:+%=#%*######**####*****#****+++++**++**#%%%#%%%%%##%%%%%%%%%###%##########
################*:-::.*--:=+++-#**######*******###***********+*##*%**#%%%%%%%%%%%%##################
#############+:-.-.:=:.:=--=*=-+****######*********************#%##+*%**+#%%%%%%%%%%%%%%%%%%%%%#%%%%
##########-::.:..=...=..-:..+++=+=****#####*******************@*#*@**#++#+===*%%%%%%%%%%%%##########
######+::.::..+:..-.::.:...:-*=++=*****######****************#@##***%#*+*==*--::*%%%%%%%%%%%%%%%%%%@
###-:=::...+.:..-:.::.+:::.+:++*==:***##########************#@@%%********+-+.:+:-:+%%%%%%%%%%%%%%%%%
--=..-..+...:=.--:.:+.:.:..=:=-+=+=*-**##########*********##%@%##%***#**===+-:::----%%%%%%%%%%%%%%%%
.-:..+....-.-:::.*.:..*..-.:.--=*--:+#***#*#######*****#**#%@%%#*****#++=*-*:::.=.:=-#%%%%%%%%%%%%%%
-.==...=:-.-..*=:+.-=.=::-.:.=:+.+=-+:******#######***####%@@%#*=*#*++=*=++-=.--=--:::*%%%%%%%%%%%%%
+.:.--=.=..+.-:+....-..:.=:..-:+.++-=:+*********#########%@@@*+*-*+++=++:--==+=:*--:+:++%%%%%%%%%%%%
-:+..-:-:+..:::+..=:--.=.+::.=:=..:+.+:+++********#######%@@%#++--==+--*::-#:-++:.*--=+:-%%%%%%%%%%%
:.--.:...--.==-.+::.-+-:.+::.-:=..-=++.=++++*******#####%%@@*#=:=.=-*=-:-+:+:-=-+-=-:----=%%%%%%%%%%
.=:+..--=:+:..-:=-::-*-:.=:-.-::..=:--+-==+++******#####%%%***-:=:--::--=--::+:-==-=--*-=-=%%%%%%%%%
-+-+:.-..-+....:-.-=---:.=.-.-:.-.=.=:+.-==+++*****#####%*#*++*-.:.=.+-:-:-:+.-::-:-==:-*-==%%%%%%%%
::..*-.:+---:-:-:+-=.:#:.-.:.:..=.-.---#+==++++******###*++==-:-.=@%----:-:-::+++:+--:-=+:*:-%%%%%%%
.=.-*:.=.=.*-.:=-+:-:--:.=-:..+*#%#@%@%@@@-+++++*****##++*+---:=.*@%%%%=-==-:+:.+:===-==*::-+=%%%%%%
..=--+-::.-+-.==----+=*++%#%%%%%@%%%%%%#*@##*++++****#**-*#%#%##%#%#%%%@%%+:--:=-+:===++*=::+==%%%%%
*:::-*-.==-*::=-::*--:##%#%%%#@%#+-#%##*#=*%@*+++++****+++=%#%%%##*#%##@%%+:+=*:-+-+--=-#=-:+-++%%%%
 -}